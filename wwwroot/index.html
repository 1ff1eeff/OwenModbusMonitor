<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд ПР-103</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sensor-card { text-align: center; margin-bottom: 20px; }
        .value-display { font-size: 4em; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 0.5em; color: #7f8c8d; }
        canvas { max-height: 400px; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; color: white; margin: 0 5px; }
        .btn-start { background-color: #2ecc71; }
        .btn-stop { background-color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sensor-card">
            <h2>Датчик Давления</h2>
            <div class="value-display">
                <span id="pressureValue">--</span>
                <span class="unit">бар</span>
            </div>
        </div>
        <canvas id="pressureChart"></canvas>
        <div class="controls">
            <button class="btn-start" onclick="startMonitoring()">Старт</button>
            <button class="btn-stop" onclick="stopMonitoring()">Стоп</button>
            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>Уставка:</label>
                <input type="number" id="setpointInput" step="0.1" style="padding: 5px; width: 80px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="sendSetpoint()" style="background-color: #3498db;">Задать</button>
                <span style="font-size: 0.9em; color: #555; margin-left: 10px;">Текущая: <span id="currentSetpoint">--</span></span>
            </div>
        </div>
    </div>

    <script>
        const totalPoints = 60;
        const writeIndex = 48; // Точка записи данных (80% от ширины)

        const ctx = document.getElementById('pressureChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: new Array(totalPoints).fill(''),
                datasets: [{
                    label: 'Давление (бар)',
                    data: new Array(totalPoints).fill(null),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    fill: true,
                    tension: 0.3,
                    spanGaps: true
                }]
            },
            options: {
                scales: { x: { display: false }, y: { beginAtZero: true } },
                animation: false
            }
        });

        let isMonitoring = true;

        async function updateData() {
            if (!isMonitoring) return;

            try {
                const response = await fetch('/api/data');
                const data = await response.json();

                // Если данные еще не получены (null), пропускаем обновление
                if (data.pressure === null) return;
                
                document.getElementById('pressureValue').innerText = data.pressure.toFixed(2);

                // Отображаем текущую уставку
                if (data.setpoint !== null) document.getElementById('currentSetpoint').innerText = data.setpoint.toFixed(2);

                // Устанавливаем максимум оси Y равным уставке * 2
                if (data.setpoint !== null && data.setpoint > 0) {
                    chart.options.scales.y.max = data.setpoint * 2;
                }

                // Сдвигаем график влево (удаляем старое)
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                // Добавляем пустое место в конец, чтобы сохранить ширину окна
                chart.data.labels.push('');
                chart.data.datasets[0].data.push(null);
                // Записываем текущие данные в фиксированную позицию (80%)
                chart.data.labels[writeIndex] = new Date().toLocaleTimeString();
                chart.data.datasets[0].data[writeIndex] = data.pressure;
                
                chart.update();
            } catch (err) { console.error(err); }
        }
        setInterval(updateData, 500);

        async function startMonitoring() {
            isMonitoring = true;
            await fetch('/api/start', { method: 'POST' });
        }

        async function stopMonitoring() {
            isMonitoring = false;
            await fetch('/api/stop', { method: 'POST' });
        }

        async function sendSetpoint() {
            const val = document.getElementById('setpointInput').value;
            if (!val) return;
            await fetch('/api/setpoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: parseFloat(val) })
            });
        }
    </script>
</body>
</html>