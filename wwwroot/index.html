<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –ü–†-103</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sensor-card { text-align: center; margin-bottom: 20px; }
        .value-display { font-size: 4em; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 0.5em; color: #7f8c8d; }
        canvas { max-height: 400px; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; color: white; margin: 0 5px; }
        .btn-start { background-color: #2ecc71; }
        .btn-stop { background-color: #e74c3c; }
        .btn-reset { background-color: #f39c12; }
        .btn-log { background-color: #34495e; }
        @keyframes flash-red { 0% { background-color: #f4f4f9; } 50% { background-color: #ffcccc; } 100% { background-color: #f4f4f9; } }
        .alarm-bg { animation: flash-red 1s infinite; }
        .error-list { margin-top: 20px; }
        .error-item { background-color: #f8d7da; color: #721c24; padding: 10px; margin-bottom: 5px; border: 1px solid #f5c6cb; border-radius: 4px; font-weight: bold; }
        .new-log { animation: flash-log 3s ease-out; border-radius: 2px; }
        @keyframes flash-log { 0% { background-color: #e67e22; } 100% { background-color: transparent; } }
        @keyframes flash-button { 0% { background-color: #34495e; } 50% { background-color: #e67e22; } 100% { background-color: #34495e; } }
        .btn-flash { animation: flash-button 1s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sensor-card">
            <h2>–î–∞—Ç—á–∏–∫ –î–∞–≤–ª–µ–Ω–∏—è</h2>
            <div id="statusBadge" style="display: inline-block; padding: 5px 10px; border-radius: 15px; background: #95a5a6; color: white; font-weight: bold; margin-bottom: 10px;">--</div>
            <div class="value-display">
                <span id="pressureValue">--</span>
                <span class="unit">–±–∞—Ä</span>
            </div>
            <div style="margin-top: 10px; font-size: 1.2em; color: #27ae60; font-weight: bold;">
                –ì–æ–¥–Ω—ã—Ö: <span id="goodCount">0</span>
            </div>
            <div style="margin-top: 5px; font-size: 1.2em; color: #c0392b; font-weight: bold;">
                –ë—Ä–∞–∫: <span id="failCount">0</span>
            </div>
        </div>
        <canvas id="pressureChart"></canvas>
        <div class="controls">
            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>–£—Å—Ç–∞–≤–∫–∞:</label>
                <input type="number" id="setpointInput" step="0.1" style="padding: 5px; width: 80px; border: 1px solid #ccc; border-radius: 4px;">
                <select onchange="document.getElementById('setpointInput').value = this.value" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                    <option value="6.3">6.3</option>
                    <option value="16">16</option>
                    <option value="35">35</option>
                    <option value="50">50</option>
                </select>
                <button onclick="sendSetpoint()" style="background-color: #3498db;">–ó–∞–¥–∞—Ç—å</button>
                <span style="font-size: 0.9em; color: #555; margin-left: 10px;">–¢–µ–∫—É—â–∞—è: <span id="currentSetpoint">--</span></span>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn-start" onclick="startMonitoring()">–°—Ç–∞—Ä—Ç</button>
                <button class="btn-stop" onclick="stopMonitoring()">–°—Ç–æ–ø</button>
                <button class="btn-reset" onclick="resetSystem()">–°–±—Ä–æ—Å</button>
                <button id="btnLog" class="btn-log" onclick="toggleLogs()">–ñ—É—Ä–Ω–∞–ª</button>
            </div>
        </div>
        <div id="errorList" class="error-list"></div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π -->
        <div id="logContainer" style="display:none; margin-top: 20px; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; text-align: left;">
            <div style="margin-bottom: 10px; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;">
                <div>
                    <span>–í—Å–µ–≥–æ: <span id="logTotal">0</span></span>
                    <select id="pageSizeSelect" onchange="changePageSize()" style="margin-left: 10px; padding: 2px; background: #34495e; color: white; border: 1px solid #7f8c8d; border-radius: 3px;">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <select id="sortSelect" onchange="changeSort()" style="margin-left: 10px; padding: 2px; background: #34495e; color: white; border: 1px solid #7f8c8d; border-radius: 3px;">
                        <option value="desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                    </select>
                    <input type="text" id="logFilter" placeholder="–§–∏–ª—å—Ç—Ä..." style="margin-left: 10px; padding: 2px 5px; width: 120px; background: #34495e; color: white; border: 1px solid #7f8c8d; border-radius: 3px;" oninput="filterLogs()">
                    <button onclick="clearLogs()" title="–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª" style="margin-left: 10px; padding: 2px 8px; background: #c0392b; border: none; border-radius: 3px; cursor: pointer; color: white;">üóëÔ∏è</button>
                    <button onclick="downloadLogs()" title="–°–∫–∞—á–∞—Ç—å –∂—É—Ä–Ω–∞–ª" style="margin-left: 5px; padding: 2px 8px; background: #2980b9; border: none; border-radius: 3px; cursor: pointer; color: white;">üíæ</button>
                </div>
                <div>
                    <button id="btnPrevPage" onclick="changePage(-1)" style="padding: 2px 8px; background: #7f8c8d; font-size: 0.9em;">&lt;</button>
                    <span id="logPageDisplay" style="margin: 0 8px;">1</span>
                    <button id="btnNextPage" onclick="changePage(1)" style="padding: 2px 8px; background: #7f8c8d; font-size: 0.9em;">&gt;</button>
                </div>
            </div>
            <div id="logContent" style="max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        const totalPoints = 60;
        const writeIndex = 48; // –¢–æ—á–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö (80% –æ—Ç —à–∏—Ä–∏–Ω—ã)

        // –ü–ª–∞–≥–∏–Ω –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏
        const verticalLinePlugin = {
            id: 'verticalLine',
            afterDraw: (chart) => {
                const ctx = chart.ctx;
                const yAxis = chart.scales.y;
                const meta = chart.getDatasetMeta(0);
                const point = meta.data[writeIndex];
                const x = point.x;
                const y = point.y;
                
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, yAxis.top);
                ctx.lineTo(x, yAxis.bottom);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)'; // –ö—Ä–∞—Å–Ω—ã–π –ø—É–Ω–∫—Ç–∏—Ä
                ctx.setLineDash([5, 5]);
                ctx.stroke();

                const value = chart.data.datasets[0].data[writeIndex];
                if (value !== null && value !== undefined) {
                    ctx.font = 'bold 12px Segoe UI';
                    ctx.fillStyle = '#c0392b';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`–î–∞–≤–ª–µ–Ω–∏–µ: ${value.toFixed(2)}`, x + 5, y);
                }
                ctx.restore();
            }
        };

        const ctx = document.getElementById('pressureChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: new Array(totalPoints).fill(''),
                datasets: [{
                    label: '–î–∞–≤–ª–µ–Ω–∏–µ (–±–∞—Ä)',
                    data: new Array(totalPoints).fill(null),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    fill: true,
                    tension: 0.3,
                    spanGaps: true
                }]
            },
            options: {
                scales: { x: { display: false }, y: { beginAtZero: true } },
                animation: false
            },
            plugins: [verticalLinePlugin]
        });

        async function updateData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();

                // –õ–æ–≥–∏–∫–∞ –º–∏–≥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∂—É—Ä–Ω–∞–ª–∞
                if (seenLogCount === null) seenLogCount = data.logCount; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

                const btnLog = document.getElementById('btnLog');
                const logContainer = document.getElementById('logContainer');

                if (data.logCount > seenLogCount) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –∏ –∂—É—Ä–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç -> –º–∏–≥–∞–µ–º
                    if (logContainer.style.display === 'none') {
                        btnLog.classList.add('btn-flash');
                    } else {
                        // –ï—Å–ª–∏ –∂—É—Ä–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–µ –ª–æ–≥–∏
                        seenLogCount = data.logCount;
                        btnLog.classList.remove('btn-flash');
                    }
                } else if (data.logCount < seenLogCount) {
                    // –ï—Å–ª–∏ –ª–æ–≥–∏ –±—ã–ª–∏ –æ—á–∏—â–µ–Ω—ã
                    seenLogCount = data.logCount;
                    btnLog.classList.remove('btn-flash');
                }

                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã (null), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (data.pressure === null) return;
                
                document.getElementById('pressureValue').innerText = data.pressure.toFixed(2);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                document.getElementById('goodCount').innerText = data.goodCount;
                document.getElementById('failCount').innerText = data.failCount;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —É—Å—Ç–∞–≤–∫—É
                if (data.setpoint !== null) {
                    document.getElementById('currentSetpoint').innerText = data.setpoint.toFixed(2);
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                    if (!isSetpointInitialized) {
                        document.getElementById('setpointInput').value = data.setpoint;
                        isSetpointInitialized = true;
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
                const statusBadge = document.getElementById('statusBadge');
                if (data.fail === 1) {
                    document.body.classList.add('alarm-bg');
                    statusBadge.innerText = "–ù–ï –ì–û–î–ï–ù";
                    statusBadge.style.backgroundColor = "#c0392b"; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                } else if (data.overPressure === 1) {
                    document.body.classList.add('alarm-bg');
                    statusBadge.innerText = "–ê–í–ê–†–ò–Ø –î–ê–í–õ–ï–ù–ò–Ø";
                    statusBadge.style.backgroundColor = "#c0392b"; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                } else if (data.success === 1) {
                    document.body.classList.remove('alarm-bg');
                    statusBadge.innerText = "–ì–û–î–ï–ù";
                    statusBadge.style.backgroundColor = "#27ae60"; // –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
                } else {
                    document.body.classList.remove('alarm-bg');
                    if (data.start === 1) {
                        statusBadge.innerText = "–†–ê–ë–û–¢–ê";
                        statusBadge.style.backgroundColor = "#2ecc71"; // –ó–µ–ª–µ–Ω—ã–π
                    } else if (data.stop === 1) {
                        statusBadge.innerText = "–û–°–¢–ê–ù–û–í–õ–ï–ù–û";
                        statusBadge.style.backgroundColor = "#e74c3c"; // –ö—Ä–∞—Å–Ω—ã–π
                    } else {
                        statusBadge.innerText = "–ì–û–¢–û–í";
                        statusBadge.style.backgroundColor = "#95a5a6"; // –°–µ—Ä—ã–π
                    }
                }

                // –í—ã–≤–æ–¥ —Å–ø–∏—Å–∫–∞ –æ—à–∏–±–æ–∫
                const errorList = document.getElementById('errorList');
                errorList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫
                const errors = [];
                if (data.setpointReached === 1) errors.push("‚úÖ –£—Å—Ç–∞–≤–∫–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞");
                if (data.utechka === 1) errors.push("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞");
                if (data.overPressure === 1) errors.push("‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è");
                if (data.errDD === 1) errors.push("‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è");
                if (data.errSetpoint === 1) errors.push("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –Ω–∞ —É—Å—Ç–∞–≤–∫—É");
                if (data.fail === 1) errors.push("‚ùå –ò–∑–¥–µ–ª–∏–µ –Ω–µ –≥–æ–¥–Ω–æ");
                if (data.success === 1) errors.push("‚úÖ –ò–∑–¥–µ–ª–∏–µ –≥–æ–¥–Ω–æ");

                errors.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'error-item';
                    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ‚úÖ), –∫—Ä–∞—Å–∏–º –≤ –∑–µ–ª–µ–Ω—ã–π
                    if (msg.includes('‚úÖ')) {
                        div.style.backgroundColor = '#d4edda';
                        div.style.color = '#155724';
                        div.style.borderColor = '#c3e6cb';
                    }
                    div.innerText = msg;
                    errorList.appendChild(div);
                });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º –æ—Å–∏ Y —Ä–∞–≤–Ω—ã–º —É—Å—Ç–∞–≤–∫–µ * 1.5
                if (data.setpoint !== null && data.setpoint > 0) {
                    chart.options.scales.y.max = data.setpoint * 1.5;
                }

                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ì–æ–¥–µ–Ω" –∏–ª–∏ "–ù–µ –≥–æ–¥–µ–Ω", –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º (–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º)
                if (data.success !== 1 && data.fail !== 1) {
                    // –°–¥–≤–∏–≥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤–ª–µ–≤–æ (—É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ)
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –≤ –∫–æ–Ω–µ—Ü, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É –æ–∫–Ω–∞
                    chart.data.labels.push('');
                    chart.data.datasets[0].data.push(null);
                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (80%)
                    chart.data.labels[writeIndex] = new Date().toLocaleTimeString();
                    chart.data.datasets[0].data[writeIndex] = data.pressure;
                    
                    chart.update();
                }
            } catch (err) { console.error(err); }
        }
        setInterval(updateData, 500);

        async function startMonitoring() {
            await fetch('/api/start', { method: 'POST' });
        }

        async function stopMonitoring() {
            await fetch('/api/stop', { method: 'POST' });
        }

        async function sendSetpoint() {
            const val = document.getElementById('setpointInput').value;
            if (!val) return;
            await fetch('/api/setpoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: parseFloat(val) })
            });
        }

        async function resetSystem() {
            await fetch('/api/reset', { method: 'POST' });
            
            // –û—á–∏—Å—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–∑–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏)
            chart.data.labels = new Array(totalPoints).fill('');
            chart.data.datasets[0].data = new Array(totalPoints).fill(null);
            chart.update();

            // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.innerText = "–ì–û–¢–û–í";
            statusBadge.style.backgroundColor = "#95a5a6";
            document.getElementById('errorList').innerHTML = '';
            document.body.classList.remove('alarm-bg');

            // –û–±–Ω–æ–≤–ª—è–µ–º seenLogCount, —á—Ç–æ–±—ã –º–∏–≥–∞–Ω–∏–µ –Ω–µ –≤–æ–∑–æ–±–Ω–æ–≤–∏–ª–æ—Å—å
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                seenLogCount = data.logCount;
            } catch (e) { }
            // –°–±—Ä–æ—Å –º–∏–≥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∂—É—Ä–Ω–∞–ª–∞
            document.getElementById('btnLog').classList.remove('btn-flash');
        }

        let logInterval = null;
        let previousLogs = null;
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let sortOrder = 'desc';
        let seenLogCount = null;
        let isSetpointInitialized = false;

        async function fetchLogs() {
            const contentDiv = document.getElementById('logContent');
            const filter = document.getElementById('logFilter').value;
            try {
                const url = `/api/logs?filter=${encodeURIComponent(filter)}&page=${currentPage}&pageSize=${pageSize}&sort=${sortOrder}`;
                const res = await fetch(url);
                const data = await res.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
                document.getElementById('logTotal').innerText = data.total;
                document.getElementById('logPageDisplay').innerText = data.page;
                
                totalPages = Math.ceil(data.total / pageSize) || 1;
                
                const btnPrev = document.getElementById('btnPrevPage');
                const btnNext = document.getElementById('btnNextPage');
                btnPrev.disabled = currentPage <= 1;
                btnPrev.style.opacity = currentPage <= 1 ? "0.5" : "1";
                btnNext.disabled = currentPage >= totalPages;
                btnNext.style.opacity = currentPage >= totalPages ? "0.5" : "1";
                
                const logs = data.logs;

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                if (previousLogs === null || currentPage !== 1) {
                    contentDiv.innerHTML = logs.length > 0 ? logs.join('<br>') : '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç';
                } else {
                    const html = logs.map(line => {
                        return !previousLogs.includes(line) ? `<span class="new-log">${line}</span>` : line;
                    }).join('<br>');
                    contentDiv.innerHTML = logs.length > 0 ? html : '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç';
                }
                
                if (currentPage === 1) previousLogs = logs;

            } catch (e) {
                contentDiv.innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤';
            }
        }

        function toggleLogs() {
            const container = document.getElementById('logContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                document.getElementById('logContent').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                previousLogs = null;
                currentPage = 1; // –°–±—Ä–æ—Å –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                fetchLogs();
                
                // –°–±—Ä–∞—Å –º–∏–≥–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                document.getElementById('btnLog').classList.remove('btn-flash');
                // seenLogCount –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ updateData
                
                logInterval = setInterval(fetchLogs, 2000);
            } else {
                container.style.display = 'none';
                if (logInterval) clearInterval(logInterval);
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            fetchLogs();
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            previousLogs = null;
            fetchLogs();
        }

        function changeSort() {
            sortOrder = document.getElementById('sortSelect').value;
            currentPage = 1;
            previousLogs = null;
            fetchLogs();
        }

        function filterLogs() {
            currentPage = 1;
            previousLogs = null;
            fetchLogs();
        }

        async function clearLogs() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫?')) {
                await fetch('/api/logs/clear', { method: 'POST' });
                previousLogs = null;
                if (document.getElementById('logContainer').style.display !== 'none') fetchLogs();
            }
        }

        function downloadLogs() {
            window.location.href = '/api/logs/download';
        }
    </script>
</body>
</html>